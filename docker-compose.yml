version: "3.8"

services:
  backend:
    build:
      context: .  # `emory/` をコンテキストとして指定
      dockerfile: backend/Dockerfile
    container_name: flask_app
    env_file:
      - config.env  
    environment:
      - PYTHONPATH=/emory  # ✅ backend を Python モジュールとして認識
    depends_on:
      - mysql
      - mysql_test  # ✅ テスト用 MySQL に依存
    volumes:
      - .:/emory  # ✅ ルートディレクトリを `/emory` としてマウント
    command: ["sh", "-c", "sleep 10 && python backend/run.py"]
    ports:
      - "${FLASK_PORT}:${FLASK_PORT}"

  mysql:
    image: mysql:8.0
    container_name: mysql_db
    restart: always
    env_file:
      - ./config.env
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_PASSWORD_development}"
      MYSQL_DATABASE: "${DB_NAME_development}"
      MYSQL_USER: "${DB_USER_development}"
      MYSQL_PASSWORD: "${DB_PASSWORD_development}"
    ports:
      - "${DB_PORT_development}:${DB_PORT_development}"
    volumes:
      - mysqldata:/var/lib/mysql

  mysql_test:
    image: mysql:8.0
    container_name: mysql_test_db
    restart: always
    env_file:
      - ./config.env
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_PASSWORD_test}"
      MYSQL_DATABASE: "${DB_NAME_test}"
      MYSQL_USER: "${DB_USER_test}"
      MYSQL_PASSWORD: "${DB_PASSWORD_test}"
    ports:
      - "${DB_PORT_test}:${DB_PORT_test}"
    volumes:
      - mysqldata_test:/var/lib/mysql

volumes:
  mysqldata:
  mysqldata_test:
